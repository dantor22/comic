<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Comic Reader</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: #000;
            color: #fff;
            height: 100vh;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            touch-action: none;
        }

        .header {
            background: #1a1a1a;
            padding: 10px;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 50px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .menu-btn {
            background: none;
            border: none;
            color: #fff;
            font-size: 24px;
            padding: 5px;
            cursor: pointer;
        }

        .page-indicator {
            background: #2a2a2a;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        #pageNum {
            width: 30px;
            background: transparent;
            border: none;
            color: #fff;
            text-align: center;
            font-size: 14px;
        }

        .upload-btn-mobile {
            background: #4a9eff;
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
        }

        .viewer {
            flex: 1;
            position: relative;
            overflow: hidden;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #pdfCanvas {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
            display: none;
            touch-action: pinch-zoom;
        }

        #pdfCanvas.active {
            display: block;
        }

        .welcome {
            text-align: center;
            padding: 20px;
        }

        .welcome-icon {
            font-size: 72px;
            margin-bottom: 20px;
        }

        .welcome p {
            color: #888;
            font-size: 16px;
            margin-bottom: 30px;
        }

        .nav-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            z-index: 10;
        }

        .nav-left, .nav-right {
            width: 50%;
            height: 100%;
            cursor: pointer;
            background: transparent;
            border: none;
            position: relative;
        }
        
        .nav-left:active::after, .nav-right:active::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .nav-left:active::before {
            content: '◀';
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 40px;
            color: rgba(255, 255, 255, 0.5);
            animation: slideLeft 0.3s ease;
        }
        
        .nav-right:active::before {
            content: '▶';
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 40px;
            color: rgba(255, 255, 255, 0.5);
            animation: slideRight 0.3s ease;
        }
        
        @keyframes slideLeft {
            from { transform: translateY(-50%) translateX(10px); opacity: 0; }
            to { transform: translateY(-50%) translateX(0); opacity: 1; }
        }
        
        @keyframes slideRight {
            from { transform: translateY(-50%) translateX(-10px); opacity: 0; }
            to { transform: translateY(-50%) translateX(0); opacity: 1; }
        }

        .bottom-bar {
            background: #1a1a1a;
            border-top: 1px solid #333;
            padding: 10px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            min-height: 60px;
        }

        .nav-btn {
            background: #2a2a2a;
            border: none;
            color: #fff;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s;
        }

        .nav-btn:active {
            background: #4a9eff;
            transform: scale(0.95);
        }

        .nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .zoom-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .zoom-btn {
            background: #2a2a2a;
            border: none;
            color: #fff;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
        }

        .zoom-btn:active {
            background: #4a9eff;
            transform: scale(0.95);
        }

        .zoom-level {
            font-size: 12px;
            color: #888;
            min-width: 40px;
            text-align: center;
        }

        input[type="file"] {
            display: none;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            padding: 20px;
            border-radius: 10px;
            display: none;
        }

        .loading.active {
            display: block;
        }

        .sidebar {
            position: fixed;
            top: 0;
            left: -280px;
            width: 280px;
            height: 100%;
            background: #1a1a1a;
            transition: left 0.3s;
            z-index: 1000;
            overflow-y: auto;
        }

        .sidebar.open {
            left: 0;
            box-shadow: 2px 0 10px rgba(0,0,0,0.5);
        }

        .sidebar-header {
            padding: 15px;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: between;
            align-items: center;
        }

        .sidebar-title {
            font-size: 18px;
            font-weight: 500;
        }

        .close-sidebar {
            background: none;
            border: none;
            color: #fff;
            font-size: 24px;
            cursor: pointer;
            margin-left: auto;
        }

        .sidebar-content {
            padding: 15px;
        }

        .recent-files {
            margin-top: 20px;
        }

        .recent-title {
            font-size: 14px;
            color: #888;
            margin-bottom: 10px;
        }

        .file-item {
            padding: 12px;
            background: #2a2a2a;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .file-item:active {
            background: #4a9eff;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            z-index: 999;
        }

        .overlay.open {
            display: block;
        }

        /* Gestos táctiles */
        .viewer.zooming {
            overflow: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* Landscape mode */
        @media (orientation: landscape) and (max-height: 500px) {
            .header {
                min-height: 40px;
                padding: 5px 10px;
            }
            
            .bottom-bar {
                min-height: 50px;
                padding: 5px 10px;
            }
            
            .nav-btn {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }
            
            .zoom-btn {
                width: 35px;
                height: 35px;
                font-size: 16px;
            }
        }

        /* Tablets */
        @media (min-width: 768px) {
            .nav-left, .nav-right {
                width: 20%;
            }
            
            .bottom-bar {
                padding: 15px 30px;
            }
            
            .nav-btn {
                width: 60px;
                height: 60px;
                font-size: 24px;
            }
        }

        /* Desktop */
        @media (min-width: 1024px) {
            .header {
                padding: 15px 20px;
            }
            
            .page-indicator {
                font-size: 16px;
            }
            
            #pageNum {
                width: 40px;
            }
            
            .bottom-bar {
                display: none;
            }
            
            .header {
                min-height: 60px;
            }
            
            .desktop-controls {
                display: flex;
                gap: 10px;
                align-items: center;
            }
            
            .desktop-nav-btn {
                background: #2a2a2a;
                border: 1px solid #333;
                color: #fff;
                padding: 8px 15px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 14px;
                display: inline-flex;
                align-items: center;
                gap: 5px;
            }
            
            .desktop-nav-btn:hover:not(:disabled) {
                background: #4a9eff;
            }
            
            .desktop-nav-btn:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }
        }

        /* Hide desktop controls on mobile */
        .desktop-controls {
            display: none;
        }

        @media (min-width: 1024px) {
            .desktop-controls {
                display: flex;
            }
            
            .upload-btn-mobile {
                display: none;
            }
            
            .menu-btn {
                display: none;
            }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <button class="menu-btn" id="menuBtn">☰</button>
            <div class="page-indicator">
                <input type="number" id="pageNum" value="1" min="1">
                <span>/</span>
                <span id="totalPages">0</span>
            </div>
        </div>
        
        <div class="desktop-controls">
            <button class="desktop-nav-btn" id="prevBtnDesktop" disabled>◀ Anterior</button>
            <div class="page-indicator">
                <input type="number" id="pageNumDesktop" value="1" min="1">
                <span>/</span>
                <span id="totalPagesDesktop">0</span>
            </div>
            <button class="desktop-nav-btn" id="nextBtnDesktop" disabled>Siguiente ▶</button>
            <div class="zoom-controls">
                <button class="zoom-btn" id="zoomOutDesktop">－</button>
                <span class="zoom-level" id="zoomLevelDesktop">100%</span>
                <button class="zoom-btn" id="zoomInDesktop">＋</button>
            </div>
            <button class="desktop-nav-btn" onclick="document.getElementById('fileInput').click()">
                📁 Cargar PDF
            </button>
        </div>
        
        <input type="file" id="fileInput" accept=".pdf">
        <button class="upload-btn-mobile" onclick="document.getElementById('fileInput').click()">
            📁 PDF
        </button>
    </div>

    <div class="viewer" id="viewer">
        <div class="welcome" id="welcome">
            <div class="welcome-icon">📚</div>
            <p>Toca el botón PDF para cargar una historieta</p>
        </div>
        <div class="loading" id="loading">Cargando...</div>
        <canvas id="pdfCanvas"></canvas>
        <div class="nav-overlay" id="navOverlay">
            <button class="nav-left" id="navLeft" aria-label="Página anterior"></button>
            <button class="nav-right" id="navRight" aria-label="Página siguiente"></button>
        </div>
    </div>

    <div class="bottom-bar" id="bottomBar">
        <button class="nav-btn" id="prevBtn" disabled>◀</button>
        <div class="zoom-controls">
            <button class="zoom-btn" id="zoomOut">－</button>
            <span class="zoom-level" id="zoomLevel">100%</span>
            <button class="zoom-btn" id="zoomIn">＋</button>
        </div>
        <button class="nav-btn" id="nextBtn" disabled>▶</button>
    </div>

    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <span class="sidebar-title">📚 Biblioteca</span>
            <button class="close-sidebar" id="closeSidebar">✕</button>
        </div>
        <div class="sidebar-content">
            <button class="upload-btn-mobile" style="width: 100%;" onclick="document.getElementById('fileInput').click()">
                + Cargar nuevo PDF
            </button>
            <div class="recent-files">
                <div class="recent-title">Archivos recientes</div>
                <div id="recentFiles"></div>
            </div>
        </div>
    </div>

    <div class="overlay" id="overlay"></div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        let pdfDoc = null;
        let pageNum = 1;
        let pageRendering = false;
        let pageNumPending = null;
        let scale = 1.0;
        let recentFiles = [];
        let currentFileName = '';

        const canvas = document.getElementById('pdfCanvas');
        const ctx = canvas.getContext('2d');
        const viewer = document.getElementById('viewer');
        const welcome = document.getElementById('welcome');
        const loading = document.getElementById('loading');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('overlay');
        
        // Mobile elements
        const pageNumInput = document.getElementById('pageNum');
        const totalPagesSpan = document.getElementById('totalPages');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const zoomInBtn = document.getElementById('zoomIn');
        const zoomOutBtn = document.getElementById('zoomOut');
        const zoomLevelSpan = document.getElementById('zoomLevel');
        
        // Desktop elements
        const pageNumDesktop = document.getElementById('pageNumDesktop');
        const totalPagesDesktop = document.getElementById('totalPagesDesktop');
        const prevBtnDesktop = document.getElementById('prevBtnDesktop');
        const nextBtnDesktop = document.getElementById('nextBtnDesktop');
        const zoomInDesktop = document.getElementById('zoomInDesktop');
        const zoomOutDesktop = document.getElementById('zoomOutDesktop');
        const zoomLevelDesktop = document.getElementById('zoomLevelDesktop');

        // Navigation
        const navLeft = document.getElementById('navLeft');
        const navRight = document.getElementById('navRight');
        const navOverlay = document.getElementById('navOverlay');

        // Sync desktop and mobile inputs
        function syncPageInputs(value) {
            pageNumInput.value = value;
            if (pageNumDesktop) pageNumDesktop.value = value;
        }

        function syncTotalPages(value) {
            totalPagesSpan.textContent = value;
            if (totalPagesDesktop) totalPagesDesktop.textContent = value;
        }

        function syncZoomLevel(value) {
            const text = Math.round(value * 100) + '%';
            zoomLevelSpan.textContent = text;
            if (zoomLevelDesktop) zoomLevelDesktop.textContent = text;
        }

        // Touch handling
        let touchStartX = 0;
        let touchStartY = 0;
        let initialScale = 1;
        let pinchDistance = 0;

        viewer.addEventListener('touchstart', (e) => {
            if (e.touches.length === 1) {
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
            } else if (e.touches.length === 2) {
                const dx = e.touches[0].clientX - e.touches[1].clientX;
                const dy = e.touches[0].clientY - e.touches[1].clientY;
                pinchDistance = Math.sqrt(dx * dx + dy * dy);
                initialScale = scale;
            }
        });

        viewer.addEventListener('touchmove', (e) => {
            if (e.touches.length === 2 && pdfDoc) {
                e.preventDefault();
                const dx = e.touches[0].clientX - e.touches[1].clientX;
                const dy = e.touches[0].clientY - e.touches[1].clientY;
                const currentDistance = Math.sqrt(dx * dx + dy * dy);
                const delta = currentDistance - pinchDistance;
                
                if (Math.abs(delta) > 10) {
                    scale = Math.max(0.5, Math.min(3.0, initialScale * (currentDistance / pinchDistance)));
                    syncZoomLevel(scale);
                    queueRenderPage(pageNum);
                }
            }
        });

        // Render page
        function renderPage(num) {
            pageRendering = true;
            loading.classList.add('active');
            
            pdfDoc.getPage(num).then(function(page) {
                const desiredWidth = window.innerWidth;
                const viewport = page.getViewport({scale: 1});
                
                // Auto-fit to width on mobile
                if (window.innerWidth < 1024) {
                    scale = Math.min(desiredWidth / viewport.width, 2.0);
                }
                
                const scaledViewport = page.getViewport({scale: scale});
                canvas.height = scaledViewport.height;
                canvas.width = scaledViewport.width;

                const renderContext = {
                    canvasContext: ctx,
                    viewport: scaledViewport
                };
                
                const renderTask = page.render(renderContext);
                
                renderTask.promise.then(function() {
                    pageRendering = false;
                    loading.classList.remove('active');
                    
                    if (pageNumPending !== null) {
                        renderPage(pageNumPending);
                        pageNumPending = null;
                    }
                });
            });

            syncPageInputs(num);
            syncZoomLevel(scale);
        }

        function queueRenderPage(num) {
            if (pageRendering) {
                pageNumPending = num;
            } else {
                renderPage(num);
            }
        }

        function onPrevPage() {
            if (pageNum <= 1) return;
            pageNum--;
            queueRenderPage(pageNum);
            updateButtons();
        }

        function onNextPage() {
            if (pageNum >= pdfDoc.numPages) return;
            pageNum++;
            queueRenderPage(pageNum);
            updateButtons();
        }

        function updateButtons() {
            const prevDisabled = pageNum <= 1;
            const nextDisabled = pageNum >= pdfDoc.numPages;
            
            prevBtn.disabled = prevDisabled;
            nextBtn.disabled = nextDisabled;
            if (prevBtnDesktop) prevBtnDesktop.disabled = prevDisabled;
            if (nextBtnDesktop) nextBtnDesktop.disabled = nextDisabled;
        }

        function adjustZoom(delta) {
            scale = Math.max(0.5, Math.min(3.0, scale + delta));
            syncZoomLevel(scale);
            queueRenderPage(pageNum);
        }

        function loadPDF(file) {
            if (file.type !== 'application/pdf') {
                alert('Por favor selecciona un archivo PDF');
                return;
            }

            currentFileName = file.name;
            
            const fileReader = new FileReader();
            fileReader.onload = function() {
                const typedarray = new Uint8Array(this.result);
                
                pdfjsLib.getDocument(typedarray).promise.then(function(pdf) {
                    pdfDoc = pdf;
                    syncTotalPages(pdf.numPages);
                    pageNumInput.max = pdf.numPages;
                    if (pageNumDesktop) pageNumDesktop.max = pdf.numPages;
                    pageNum = 1;
                    
                    welcome.style.display = 'none';
                    canvas.classList.add('active');
                    
                    renderPage(pageNum);
                    updateButtons();
                    updateNavOverlay();
                    
                    // Add to recent files
                    if (!recentFiles.includes(currentFileName)) {
                        recentFiles.unshift(currentFileName);
                        if (recentFiles.length > 5) recentFiles.pop();
                        updateRecentFiles();
                    }
                    
                    // Close sidebar on mobile
                    if (window.innerWidth < 1024) {
                        closeSidebarMenu();
                    }
                }).catch(function(error) {
                    alert('Error al cargar el PDF');
                    console.error(error);
                });
            };
            fileReader.readAsArrayBuffer(file);
        }

        function updateRecentFiles() {
            const container = document.getElementById('recentFiles');
            container.innerHTML = recentFiles.map(name => 
                `<div class="file-item">${name}</div>`
            ).join('');
        }

        function openSidebarMenu() {
            sidebar.classList.add('open');
            overlay.classList.add('open');
        }

        function closeSidebarMenu() {
            sidebar.classList.remove('open');
            overlay.classList.remove('open');
        }

        // Event Listeners
        document.getElementById('fileInput').addEventListener('change', (e) => {
            if (e.target.files[0]) loadPDF(e.target.files[0]);
        });

        // Mobile controls
        prevBtn.addEventListener('click', onPrevPage);
        nextBtn.addEventListener('click', onNextPage);
        zoomInBtn.addEventListener('click', () => adjustZoom(0.2));
        zoomOutBtn.addEventListener('click', () => adjustZoom(-0.2));

        // Desktop controls
        if (prevBtnDesktop) prevBtnDesktop.addEventListener('click', onPrevPage);
        if (nextBtnDesktop) nextBtnDesktop.addEventListener('click', onNextPage);
        if (zoomInDesktop) zoomInDesktop.addEventListener('click', () => adjustZoom(0.2));
        if (zoomOutDesktop) zoomOutDesktop.addEventListener('click', () => adjustZoom(-0.2));

        // Touch navigation - Areas táctiles en el PDF
        navLeft.addEventListener('click', (e) => {
            e.preventDefault();
            if (pdfDoc) onPrevPage();
        });
        
        navRight.addEventListener('click', (e) => {
            e.preventDefault();
            if (pdfDoc) onNextPage();
        });
        
        // Mostrar/ocultar overlay de navegación cuando hay PDF
        function updateNavOverlay() {
            if (pdfDoc) {
                navOverlay.style.display = 'flex';
            } else {
                navOverlay.style.display = 'none';
            }
        }

        // Page number input
        pageNumInput.addEventListener('change', function() {
            const num = parseInt(this.value);
            if (num >= 1 && num <= pdfDoc.numPages) {
                pageNum = num;
                queueRenderPage(pageNum);
                updateButtons();
            }
        });

        if (pageNumDesktop) {
            pageNumDesktop.addEventListener('change', function() {
                const num = parseInt(this.value);
                if (num >= 1 && num <= pdfDoc.numPages) {
                    pageNum = num;
                    queueRenderPage(pageNum);
                    updateButtons();
                }
            });
        }

        // Sidebar
        document.getElementById('menuBtn').addEventListener('click', openSidebarMenu);
        document.getElementById('closeSidebar').addEventListener('click', closeSidebarMenu);
        overlay.addEventListener('click', closeSidebarMenu);

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (!pdfDoc) return;
            
            switch(e.key) {
                case 'ArrowLeft':
                    onPrevPage();
                    break;
                case 'ArrowRight':
                    onNextPage();
                    break;
                case '+':
                case '=':
                    adjustZoom(0.1);
                    break;
                case '-':
                    adjustZoom(-0.1);
                    break;
            }
        });

        // Prevent zoom on double tap
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function(e) {
            const now = Date.now();
            if (now - lastTouchEnd <= 300) {
                e.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
        
        // Initialize nav overlay state
        updateNavOverlay();

        console.log('Comic Reader Mobile Ready');
    </script>
</body>
</html>